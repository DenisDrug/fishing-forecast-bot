name: Deploy to Server

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Deploy to Production Server
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SERVER_PORT }}
        script: |
          echo "üöÄ –ù–∞—á–∞–ª–æ –¥–µ–ø–ª–æ—è..."
          
          cd /root/fishing-forecast-bot
          
          echo "üì• Pulling latest changes..."
          git pull origin main
          
          # –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ
          source venv/bin/activate
          
          # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–æ—Ç–∞ –ù–ê–î–ï–ñ–ù–û
          echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–æ—Ç–∞ (–Ω–∞–¥–µ–∂–Ω–æ)..."
          # –ò—â–µ–º –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
          pkill -9 -f "python.*bot.py" 2>/dev/null || true
          # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–æ–∏—Å–∫
          ps aux | grep -E "python.*bot" | grep -v grep | awk '{print $2}' | xargs kill -9 2>/dev/null || true
          # –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
          sleep 5
          
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å—ã –∑–∞–≤–µ—Ä—à–∏–ª–∏—Å—å..."
          if pgrep -f "python.*bot.py" > /dev/null; then
            echo "‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –µ—â–µ –∂–∏–≤—ã. –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞..."
            pkill -9 -f "python"
            sleep 3
          fi
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
          echo "‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞..."
          # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –º–æ–∂–µ–º –ø–∏—Å–∞—Ç—å –≤ log —Ñ–∞–π–ª
          touch bot.log
          chmod 644 bot.log
          
          nohup python bot.py > bot.log 2>&1 &
          
          echo "‚è≥ –ñ–¥–µ–º 8 —Å–µ–∫—É–Ω–¥ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞..."
          sleep 8
          
          if pgrep -f "python.*bot.py" > /dev/null; then
            echo "‚úÖ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω!"
            echo "üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ—Ü–µ—Å—Å–µ:"
            ps aux | grep "python.*bot.py" | grep -v grep
            echo ""
            echo "üìù –õ–æ–≥–∏ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Å—Ç—Ä–æ–∫):"
            tail -5 /root/fishing-forecast-bot/bot.log
          else
            echo "‚ùå –û—à–∏–±–∫–∞: –±–æ—Ç –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è!"
            echo "üìÑ –ü–æ—Å–ª–µ–¥–Ω–∏–µ 20 —Å—Ç—Ä–æ–∫ –ª–æ–≥–∞ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:"
            tail -20 /root/fishing-forecast-bot/bot.log
            exit 1
          fi