name: Deploy to Server

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Deploy to Production Server
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SERVER_PORT }}
        script: |
          echo "ğŸš€ ĞĞ°Ñ‡Ğ°Ğ»Ğ¾ Ğ´ĞµĞ¿Ğ»Ğ¾Ñ..."
          
          cd /root/fishing-forecast-bot
          
          echo "ğŸ“¥ Pulling latest changes..."
          git pull origin main
          
          # Ğ¡ĞĞ—Ğ”ĞĞ•Ğœ VENV Ğ•Ğ¡Ğ›Ğ˜ ĞĞ•Ğ¢
          if [ ! -d "venv" ]; then
            echo "ğŸ Creating virtual environment..."
            python3 -m venv venv
          fi
          
          # ĞĞšĞ¢Ğ˜Ğ’Ğ˜Ğ Ğ£Ğ•Ğœ
          source venv/bin/activate
          
          # Ğ£Ğ¡Ğ¢ĞĞĞĞ’Ğ›Ğ˜Ğ’ĞĞ•Ğœ Ğ—ĞĞ’Ğ˜Ğ¡Ğ˜ĞœĞĞ¡Ğ¢Ğ˜
          echo "ğŸ“¦ Installing dependencies..."
          pip install --upgrade pip
          pip install -r requirements.txt
          
          # ĞŸĞ ĞĞ’Ğ•Ğ Ğ¯Ğ•Ğœ .env
          if [ ! -f ".env" ]; then
            echo "âš ï¸  WARNING: .env file missing!"
            echo "Copy .env.example to .env and fill it"
          fi
          
          echo "ğŸ›‘ Stopping current bot..."
          pkill -f "python bot.py" 2>/dev/null || true
          sleep 3
          
          echo "â–¶ï¸ Starting bot..."
          nohup python bot.py > bot.log 2>&1 &
          
          sleep 5
          
          if pgrep -f "python bot.py" > /dev/null; then
            echo "âœ… Bot deployed successfully!"
            echo "ğŸ“ Logs: /root/fishing-forecast-bot/bot.log"
          else
            echo "âŒ Bot failed to start!"
            tail -50 /root/fishing-forecast-bot/bot.log
            exit 1
          fi