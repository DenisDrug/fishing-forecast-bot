name: Deploy to Server

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Deploy to server
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        script: |
          echo "üöÄ Starting deployment..."
          cd /root/telegram-bot
          
          # –û—á–∏—â–∞–µ–º –∫—ç—à Python —á—Ç–æ–±—ã git pull —Ä–∞–±–æ—Ç–∞–ª
          find . -name "*.pyc" -delete
          find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
          
          # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
          git fetch --all
          git reset --hard origin/main
          
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º
          source venv/bin/activate
          pip install -r requirements.txt
          sudo supervisorctl restart telegram-bot
          echo "‚úÖ Deployment completed!"