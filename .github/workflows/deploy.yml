name: Deploy to Server

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Deploy to Production Server
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SERVER_PORT }}
        script: |
          echo "ğŸš€ ĞĞ°Ñ‡Ğ°Ğ»Ğ¾ Ğ´ĞµĞ¿Ğ»Ğ¾Ñ..."
          
          # ĞŸĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ² Ğ¿Ğ°Ğ¿ĞºÑƒ Ñ Ğ±Ğ¾Ñ‚Ğ¾Ğ¼
          cd /root/fishing-forecast-bot
          
          # ĞŸÑƒĞ»Ğ»Ğ¸Ğ¼ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ñ GitHub
          echo "ğŸ“¥ Pulling latest changes from GitHub..."
          git pull origin main
          
          # ĞĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€ÑƒĞµĞ¼ Ğ²Ğ¸Ñ€Ñ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ğµ
          source venv/bin/activate
          
          # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ ĞµÑĞ»Ğ¸ requirements Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ğ»ÑÑ
          echo "ğŸ“¦ Checking for dependency updates..."
          if git diff --name-only HEAD~1 HEAD | grep -q "requirements.txt"; then
            echo "Updating Python dependencies..."
            pip install -r requirements.txt
          fi
          
          # ĞÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ Ğ±Ğ¾Ñ‚Ğ°
          echo "ğŸ›‘ Stopping current bot..."
          pkill -f "python bot.py" 2>/dev/null || true
          sleep 3
          
          # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ±Ğ¾Ñ‚Ğ° Ğ² Ñ„Ğ¾Ğ½Ğµ
          echo "â–¶ï¸ Starting bot..."
          nohup python bot.py > bot.log 2>&1 &
          
          # Ğ”Ğ°ĞµĞ¼ Ğ²Ñ€ĞµĞ¼Ñ Ğ½Ğ° Ğ·Ğ°Ğ¿ÑƒÑĞº
          sleep 5
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‡Ñ‚Ğ¾ Ğ±Ğ¾Ñ‚ Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ğ»ÑÑ
          if pgrep -f "python bot.py" > /dev/null; then
            echo "âœ… Bot deployed successfully!"
            echo "ğŸ“‹ Bot process info:"
            ps aux | grep "python bot.py" | grep -v grep
            echo "ğŸ“ Logs available at: /root/fishing-forecast-bot/bot.log"
          else
            echo "âŒ Bot failed to start!"
            echo "ğŸ“„ Last 50 lines of log:"
            tail -50 /root/fishing-forecast-bot/bot.log
            exit 1
          fi